<!-- 

  <ion-header>

       <ion-toolbar class="glass-toolbar" color="light" style="height: 33px;" translucent="true" mode="md">
    </ion-toolbar>
    
    <ion-toolbar [color]="rol === 'admin' ? 'light' : 'light'" mode="ios" >
      <ion-buttons  slot="start">
        <ion-back-button style="color: black;" text="Atrás"></ion-back-button>
      </ion-buttons>
   

        <ion-buttons slot="end" color="dark" (click)="imprimir()">
    
        <ion-icon  style="color: rgb(0, 0, 0);font-size: 30px;" name="print-outline"></ion-icon>
       </ion-buttons>


      <ion-title *ngIf="pedido" style="color: rgb(0, 0, 0);">ID: {{pedido.idn}}</ion-title>
    </ion-toolbar>
  </ion-header>
<ion-content fullscreen="true" *ngIf="pedido">


 <ion-grid>
  <ion-row>
    <ion-col style="color: black;" size="6" size-md="4">

 
    
Canal<br>
<b>BUSINESS CHAT</b> <br>
<br>
     
<div  style="color: black;">
  Direccion del cliente: <br>
<b style="color: black;">{{pedido.direccion}}</b><br><br>

</div>

Cliente: <br> <u routerLink="/cliente-details/{{pedido.uid}}" style="color: black;"> {{pedido.cliente}} </u> <br> {{pedido.phone}} <br>
<a id="whatsappLinkRepa" 
(click)="goToWppCliente()"
   
   target="_blank" 
   style="display: inline-flex; align-items: center; text-decoration: none; 
          background: #7fe1bd; color: #000; padding: 6px 12px; 
          border-radius: 16px; font-size: 14px; font-weight: 500;">
  <ion-icon name="logo-whatsapp" style="margin-right: 5px; font-size: 18px;"></ion-icon>
  Contactar Cliente
</a>
<br>


<div>


<br>

</div>


<div *ngIf="pedido.typePay === 'Efectivo'" style="font-size: 18px;color: rgb(206, 22, 22);font-weight: bold;margin-top: 10px;">

   Cobrar al repartidor:<br>
<b>${{pedido.total - 10}} </b><br>

</div>

<div *ngIf="pedido.typePay !== 'Efectivo'" style="font-size: 18px;color: green;font-weight: bold;margin-top: 10px;">

   Pedido pagado:
<br>

</div>



<b style="color: black;"> Repartidor</b><br>
<b style="color: black;">{{pedido.RepaName}}</b><br>
<b style="color: #000;">{{pedido.CelRepa}}</b><br>

<a *ngIf="!!pedido.CelRepa" id="whatsappLinkRepa" 
(click)="goToWppRepa()"
   
   target="_blank" 
   style="display: inline-flex; align-items: center; text-decoration: none; 
          background: #7fe1bd; color: #000; padding: 6px 12px; 
          border-radius: 16px; font-size: 14px; font-weight: 500;">
  <ion-icon name="logo-whatsapp" style="margin-right: 5px; font-size: 18px;"></ion-icon>
  Contactar Repartidor
</a>
<div >
  Total del pedido: <br>
<b>${{getFormattedPrice(+pedido.envio + +pedido.total + (+pedido.tfll || 0) - 10)}}</b><br><br>


</div>

    </ion-col>
    <ion-col size="6" size-md="4">

      Hora del pedido<br>
<b>{{ pedido.fecha }}</b><br>
<br>

Modo de entrega<br>
<b>A domicilio </b><br>

<br>

Metodo de pago<br>
<b>{{pedido.typePay}}</b><br><br>




      <br><br>
    <div >
        Costo de envio <br>
        <b>${{getFormattedPrice(+pedido.envio)}}</b><br><br>
      
 
 
    </div>
    </ion-col>
    <ion-col size="12" style="display: none;" size-md="4">
      <div style="text-align: left; border: 1px solid #ccc; width: 300px; height: auto; padding: 15px; border-radius: 10px; box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); background-color: #f9f9f9;">
        <h3 style="margin-bottom: 15px; color: #333;">Resumen del Pedido</h3>
        <p style="margin: 5px 0; color: #555;">
          <strong>Total carrito:</strong>  ${{ getFormattedPrice(pedido.total)}} 
        </p>
        <p style="margin: 5px 0; color: #555;">
          <strong>Gastos de envío:</strong>  ${{ getFormattedPrice(pedido.envio)}}
        </p>
        
        <p style="margin: 5px 0; color: #555;">
          <strong>Tarifa de lluvia:</strong> ${{ getFormattedPrice(pedido.tfll || 0)}}
        </p>
        <p style="margin: 5px 0; color: #555;">
          <strong>Tarifa de servicio:</strong>  ${{ pedido.tfs}}
        </p>
      
        <hr style="margin: 15px 0; border: none; border-top: 1px solid #ccc;" />
        <p style="margin: 5px 0; font-size: 16px; font-weight: bold; color: #222;">
          <strong>Total:</strong> ${{getFormattedPrice(+pedido.total + +pedido.envio + +pedido.tfs +  (+pedido.tfll || 0)) }}
        </p>
      </div>
      
    </ion-col>
    <ion-col size="12">
      <div style="height: 1x; border-width: 0.5px;border-style: dashed;width: 100%;">

      </div>

    </ion-col>

    <ion-col size="12" *ngIf="pedido.status === 'Pendiente'">
      <div style="text-align: center;">
      <img *ngIf="pedido.typePay === 'Transferencia'" src="{{pedido.imgTrans}}" (click)="openModalImg(pedido.imgTrans)" style="height: 200px;width: 100px;">

      </div>
       
    </ion-col>
    <ion-col size="12">

      <div *ngIf="pedido.notaPedido !== ''" style="text-align: center;">
        <b style="color: rgb(255, 110, 110);">
          NOTA:
          </b>
          {{pedido.notaPedido}}
      </div>
        <div *ngIf="pedido.notaPedido !== ''" style="height: 1x; border-width: 0.5px;border-style: dashed;width: 100%;">

      </div>
    

  <ion-row *ngFor="let item of pedido.items">

        <ion-col size="1.5">
          <b style="font-size: 10px;">  Cant.</b>
        </ion-col>
        <ion-col size="7.5" >
      <b style="font-size: 10px;">  Productos</b>
      </ion-col>
      <ion-col size="0.5"> 

      </ion-col>
      <ion-col size="2.5">
        <b style="font-size: 10px;">Precio</b>
      </ion-col>
        <ion-col size="1.5" style="padding: 0px;">
        <div style="display: inline-block;color: rgb(0, 0, 0);font-size: 17px;border-radius: 50%;padding: 4px;width: 30px;height: 30px;text-align: right;padding-bottom: 1px; "> 
      <br>  {{item.quantity}} x
      </div> 
       
    </ion-col>
      <ion-col size="7.5">

  
      <b>
        {{ item.name }}
        <br>

      </b>

      <div style="color: rgb(33, 33, 33); padding: 5px 0; font-size: 14px;" [innerHTML]="formatTextoToppings(item.tptxt)">

      </div>


    
   
 
      </ion-col>
        <ion-col size="0.5">
    
      </ion-col>
      <ion-col size="2.5">
        <b>$ {{ item.price * item.quantity }}</b>
     
      </ion-col>

      <div style="height: 2x; border-width: 1px;border-style: dashed;width: 100%;">

      </div>
    </ion-row>
    
<br>


    </ion-col>


  </ion-row>
 </ion-grid> 

 <ion-card style="border-radius: 10px; border: 1px solid #ccc; padding: 16px;display: none;">
  <ion-card-header>
    <ion-card-title style="font-size: 18px; color: #333;">Eventos del pedido</ion-card-title>
  </ion-card-header>

  <ion-card-content style="font-size: 14px; color: #555;">

    <p *ngIf="pedido.cancelBy"><strong>Cancelado por:</strong> {{ pedido.cancelBy }}</p>
    <p *ngIf="pedido.acceptBy"><strong>Aceptado por:</strong> {{ acceptByName }}</p>
    <p *ngIf="pedido.motivo"><strong>Motivo de cancelación:</strong> {{ pedido.motivo }}</p>
    <p *ngIf="pedido.acceptTime"><strong>Hora de aceptación:</strong> {{ pedido.acceptTime }}</p>
    <p *ngIf="pedido.cancelTime"><strong>Hora de cancelación:</strong> {{ pedido.cancelTime }}</p>
  
  </ion-card-content>
  
</ion-card>

  
</ion-content>

<ion-footer *ngIf="pedido">
  <ion-button color="secondary" 
  shape="round" expand="full" (click)="actualizarStatusPedido(pedido.id, 'Listo para recoger' , 
  pedido.uid)" [disabled]="isLoading" *ngIf="pedido.status === 'En preparacion'"> 
   Listo para recoger
   <ion-spinner *ngIf="isLoading" name="dots"></ion-spinner>
   
                </ion-button>

                <ion-button shape="round" color="secondary" expand="full"
                (click)="actualizarStatusPedido(pedido.id, 'En preparacion', pedido.uid)" 
                *ngIf="pedido.status === 'Aceptado'"
                [disabled]="isLoading">
         Preparando pedido
         <ion-spinner *ngIf="isLoading" name="dots"></ion-spinner>
        </ion-button>

<div style="text-align: center;">
  <ion-icon *ngIf="pedido.status === 'Nuevo'"  
  (click)="mostrarAlertaCancelacion(pedido.id,pedido.uid, pedido.nameRest, pedido.idBs,pedido.idrepa, pedido)" 
  name="close-circle" style="font-size: 75px;color: red;margin-right: 10px;">

  </ion-icon>

  <ion-icon *ngIf="pedido.status === 'Nuevo'" (click)="presentTiempoEntregaAlert(pedido.id,pedido.uid, pedido.nameRest, pedido)"
   name="checkmark-circle" style="font-size: 75px;color: green;margin-left: 10px;">

  </ion-icon>

  <ion-icon *ngIf="pedido.status === 'Pendiente'"  
  (click)="mostrarAlertaCancelacion(pedido.id,pedido.uid, pedido.nameRest, pedido.idBs,pedido.idrepa, pedido)" 
  name="close-circle" style="font-size: 75px;color: red;margin-right: 10px;">

  </ion-icon>

 <ion-icon *ngIf="pedido.status === 'Pendiente'" (click)="aceptarPedidoTransferencia(pedido.id,pedido.uid, pedido.nameRest, pedido.idBs, pedido.uidBs, pedido.cliente, pedido.autoacctype, pedido)"
  name="checkmark-circle" style="font-size: 75px;color: rgb(41, 0, 128);margin-left: 10px;">

 </ion-icon>

</div>
      
  <ion-button style="display: none;" shape="round" [disabled]="isLoading" expand="full" (click)="presentTiempoEntregaAlert(pedido.id ,pedido.uid,pedido.nameRest, pedido)"
   *ngIf="pedido.status === 'Nuevo'" color="secondary"> 
   Aceptar pedido
   <ion-spinner *ngIf="isLoading" name="dots"></ion-spinner>
   
                </ion-button>
</ion-footer> -->


<!-- TEMPLATE: pedido-detail.component.html -->
<ion-header *ngIf="pedido">
  <!-- Thin top status row (ej. "Listo en 9min") -->
    <ion-toolbar *ngIf="!isLargeScreen" class="glass-toolbar" color="light" style="height: 33px;" translucent="true" mode="md">
    </ion-toolbar>

  <!-- Main toolbar -->
  <ion-toolbar mode="md" color="light" class="main-toolbar">
    <ion-buttons slot="start" style="    margin-inline-start: -3px;">
      <ion-back-button defaultHref="/panel/{{this.currentBusiness}}" text="" icon="chevron-back-outline" class="back-ios"></ion-back-button>
    </ion-buttons>

  <ion-title class="ios-title" style="padding-inline-start: 0px;color: #000;font-size: 16px;">
  {{ pedido.cliente || 'Karla.' }}
  &nbsp; 
  <span class="small-id">
    #{{ pedido.idn?.slice(-5) }}
    <br>
    
  </span>
    <span class="small-id">
    {{ pedido.phone?.slice(-10) }}
    <br>
    
  </span>
</ion-title>


    <!-- Right icons (mantengo imprimir() que tenías, los demás son visuales) -->
    <ion-buttons slot="end" class="right-icons">
      <ion-button fill="clear" (click)="imprimir()" title="Imprimir">
        <ion-icon name="print-outline" class="icon-largex"></ion-icon>
      </ion-button>

      <!-- icon visual (no handler añadido para no romper) -->
      <ion-button fill="clear" (click)="copiarTexto(pedido)" title="Copiar">
        <ion-icon name="copy-outline" class="icon-largex"></ion-icon>
      </ion-button>

      <!-- icon visual: teléfono -->
      <ion-button routerLink="/p/{{this.pedido.phone}}" fill="clear" title="Llamar">
        <ion-icon name="logo-whatsapp" class="icon-largex"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  

</ion-header>

<ion-content fullscreen="true" *ngIf="pedido" class="page-content">
     <div style="text-align: center;" *ngIf="pedido.status === 'Pendiente'">
      <img *ngIf="pedido.typePay === 'Transferencia'" src="{{pedido.imgTrans}}" (click)="openModalImg(pedido.imgTrans)" style="height: 250px;width: 200px;">

      </div>
      
    <div class="top-info-inner" style="width: 100%;">
            <span class="ready-text" style="margin-left: 10px;font-size: 14px;" *ngIf="pedido.status !== 'Nuevo' && pedido.status !== 'Listo para recoger' && pedido.status !== 'En camino' && pedido.status !== 'Entregado' ">Listo en {{ pedido.readyIn || '9min' }}</span>
      <span class="ready-text" style="margin-left: 10px;font-size: 14px;" *ngIf="pedido.status === 'Listo para recoger'">Pedido listo para recoger</span>
    </div>
    <div class="top-info-inner" style="width: 100%;">
 
            <div *ngIf="pedido.devMode === 'A domicilio'" style="background: #dff2e5;padding: 9px;border-radius: 9px;letter-spacing: 1px;
            font-weight: bold;margin-left: 0px;">{{pedido.devMode}}
               </div>
                  <div *ngIf="pedido.devMode !== 'A domicilio'" style="background: #ffeaf1;padding: 9px;border-radius: 9px;letter-spacing: 1px;
            font-weight: bold;margin-left: 0px;">{{pedido.devMode}}
               </div>

  
 <div *ngIf="pedido.devMode === 'A domicilio' && !pedido.CelRepa" style="background: #ededed;padding: 11px;border-radius: 9px;letter-spacing: 1px;
            font-weight: bold;margin-left: 10px;font-size: 12px;">Buscando repartidor
              <ion-spinner type="crescent" style="font-size: 10px;width: 22px;height: 12px;"> </ion-spinner>

               </div>
      <!-- espacio a la derecha para balance -->
    </div>
  <ion-grid>
    <ion-row>

      <!-- LEFT COLUMN: Detalles cliente / repartidor -->
      <ion-col size="12" *ngIf="pedido.status !== 'Nuevo'" class="top-section-col">
        <div class="repartidor-row">
            <img src="../../assets/icon/motocicleta.png" *ngIf="pedido.RepaName" style="width: 30px;position: absolute;left: 15px;">

          <div class="repartidor-left" style="margin-left: 55px;" *ngIf="pedido.RepaName">

            <div class="repartidor-title" >Repartidor</div>
            <div class="repartidor-name" style="color: black;font-size: 13px;">{{ pedido.RepaName }}</div>
            <div class="repartidor-phone" style="color: rgb(61, 61, 61);font-size: 13px;">{{ pedido.CelRepa }}</div>

            <div class="contact-buttons">
              <a (click)="goToWppRepa()" *ngIf="!pedido.CelRepa" class="btn-wpp">
                <ion-icon name="logo-whatsapp"></ion-icon>
                Contactar Repartidor
              </a>
            </div>
          </div>

          <!-- Pill status estilo imagen "En camino" -->
              <div class="repartidor-right" *ngIf="!pedido.RepaName || pedido.status !== 'En camino' &&  pedido.status !== 'Entregado' && pedido.status !== 'Nuevo' && pedido.status !== 'Pendiente' && pedido.status !== 'Aceptado'"  >
        
          </div>
       
        </div>
      </ion-col>

     
      <!-- ITEMS / PRODUCTOS LIST -->
      <!-- <ion-col size="12" class="items-col">
        <div *ngFor="let item of pedido.items" class="order-item">
          <div class="item-qty">
            <div class="circle-qty">{{ item.quantity }} x</div>
          </div>

          <div class="item-body">
            <div class="item-name">
              <b>{{ item.name }}</b>
            </div>

            <div class="item-toppings" [innerHTML]="formatTextoToppings(item.tptxt)"></div>
          </div>

          <div class="item-price">
            <b>$ {{ item.price * item.quantity }}</b>
          </div>
        </div>
      </ion-col> -->

<ion-col size="12" class="items-col">
     <div *ngIf="pedido.notaPedido" style="text-align: center;padding: 5px;" >
          <div style="color: rgb(212, 99, 99);padding: 4px;"> NOTA: {{ pedido.notaPedido }}</div>
          </div>

  <div *ngFor="let item of pedido.items" class="order-item">

    <div class="item-qty">
      <div class="circle-qty">{{ item.quantity }} x</div>
    </div>

    <div class="item-body">

      <!-- Nombre -->
      <div class="row-line">
        <div class="line-container">
          <ion-icon name="ellipse-outline" class="check"></ion-icon>
          <div class="mini-dash"></div>
        </div>
        <b>{{ item.name }}</b>
      </div>

      <!-- Toppings -->
      <div *ngFor="let linea of formatTextoToppings(item.tptxt); let i = index; let last = last" class="row-line">

        <div class="line-container">
          <ion-icon name="ellipse-outline" class="check"></ion-icon>

          <!-- Mostrar dashed solo si NO es el último -->
          <div class="mini-dash" *ngIf="!last"></div>
        </div>

        <span class="topping-text">{{ linea }}</span>
      </div>

    </div>

    <div class="item-price">
      $ {{ item.price * item.quantity }}
    </div>

  </div>
</ion-col>


      <!-- RESUMEN: subtotal/envío/subsidio/total (alineado a la derecha como en imagen) -->
      <ion-col style="background: #f4f4f4;border-radius: 20px;" size="12" class="summary-col">
        <div class="summary-box">

                <div class="summary-row">
            <div>Subtotal:</div>
            <div class="summary-value">${{ getFormattedPrice(pedido.total) }}</div>
          </div>
          <div *ngIf="pedido.devMode === 'A domicilio'" class="summary-row">
            <div>Costo envio:</div>
            <div class="summary-value">${{ getFormattedPrice(+pedido.envio) }}</div>
          </div>
              <div *ngIf="pedido.devMode === 'A domicilio'" class="summary-row">
            <div>Subsidio:</div>
            <div class="summary-value"> - ${{subsidio}} </div>
          </div>
     
          <div class="summary-row total">
            <div>Total:</div>
            <div class="summary-value">${{ getFormattedPrice(+pedido.envio + +pedido.total - +subsidio + (+pedido.tfll || 0) - (pedido.subsidio || 0))  }}</div>
          </div>

          <br>
      <div class="summary-row">
          
            <div class="summary-value" style="font-size: 12px;">{{ pedido.fecha }}</div>
          </div>
                  <div class="summary-row">
           
            <div class="summary-value" style="font-size: 12px;">{{pedido.direccion.replace('/n','').replace('/n','').replace('/n','') }}</div>
          </div>

            <br>


    
        </div>
      </ion-col>

 

    </ion-row>
  </ion-grid>


    



</ion-content>

<!-- FOOTER: caja con sombra, parte izquierda "Cobrar $90" y botón aceptar grande -->
<ion-footer *ngIf="pedido" class="order-footer">
  <div class="footer-card">
   
    <div class="footer-left">
      <div class="payment-type">
        <span class="cash-label" style="color: green;" *ngIf="pedido.typePay === 'Efectivo'"> <img src="../../assets/icon/nota-de-moneda.png"  style="width: 16px;"> {{pedido.typePay}} </span>
        <span class="cash-label" style="color: rgb(0, 41, 128);" *ngIf="pedido.typePay === 'Transferencia'"><img src="../../assets/icon/tarjeta-de-credito.png" style="width: 16px;"> {{pedido.typePay}} </span>
      </div>

      <div class="charge-amount">
        <div class="cobrar-text" *ngIf="pedido.typePay === 'Transferencia'">Pagar al repartidor ${{pedido.envio}}</div>
        <div class="cobrar-text" *ngIf="pedido.typePay === 'Efectivo'">Cobrar al repartidor</div>
        <div class="amount">
          <!-- calculo conservando tu lógica: si es efectivo muestra valor, si no vacio -->
          <span *ngIf="pedido.typePay === 'Efectivo'"> ${{ getFormattedPrice(+pedido.total - (pedido.devMode === 'A domicilio' ? subsidio : 0)) }}</span>
          <span *ngIf="pedido.typePay !== 'Efectivo'" style="color: rgb(19, 130, 69);font-size: 14px;"> Pedido pagado</span>
        </div>
      </div>
    </div>

    <div class="footer-right" *ngIf="pedido.status === 'Nuevo' || pedido.status === 'Aceptado' || pedido.status === 'En preparacion' || pedido.status === 'En camino' || pedido.status === 'Entregado' || pedido.status === 'Pendiente'">
      <!-- ACEPTAR P/Detalle: mantengo handlers actuales / no quité ninguno -->
         <div *ngIf="pedido.status === 'Entregado'" class="repartidor-right" >
            <div class="pill-status" [ngClass]="pedido.status.replace(' ','')">{{pedido.status}}</div>
          </div>
        <ion-button shape="round" color="dark" expand="full"
                (click)="actualizarStatusPedido(pedido.id, 'En preparacion', pedido.uid)" 
                *ngIf="pedido.status === 'Aceptado'"
                [disabled]="isLoading">
        <b style="color: white;"> Preparando pedido</b>
         <ion-spinner *ngIf="isLoading" name="dots"></ion-spinner>
        </ion-button>

 <ion-button color="dark" 
  shape="round" expand="full" (click)="actualizarStatusPedido(pedido.id, 'Listo para recoger' , 
  pedido.uid)" [disabled]="isLoading" *ngIf="pedido.status === 'En preparacion'"> 
 <b style="color: white;">  LISTO PARA RECOGER</b>
   <ion-spinner *ngIf="isLoading" name="dots"></ion-spinner>
   
                </ion-button>




          <div class="actions-icons" style="text-align:center;">
      <ion-icon *ngIf="pedido.status === 'Nuevo'"
                (click)="mostrarAlertaCancelacion(pedido.id,pedido.uid, pedido.nameRest, pedido.idBs,pedido.idrepa, pedido)"
                name="close-circle" class="action-large close-icon"></ion-icon>

      <ion-icon *ngIf="pedido.status === 'Nuevo'"
                (click)="presentTiempoEntregaAlert(pedido.id,pedido.uid, pedido.nameRest, pedido)"
                name="checkmark-circle" class="action-large ok-icon"></ion-icon>

      <ion-icon *ngIf="pedido.status === 'Pendiente'"
                (click)="mostrarAlertaCancelacion(pedido.id,pedido.uid, pedido.nameRest, pedido.idBs,pedido.idrepa, pedido)"
                name="close-circle" class="action-large close-icon"></ion-icon>

      <ion-icon *ngIf="pedido.status === 'Pendiente'"
                (click)="aceptarPedidoTransferencia(pedido.id,pedido.uid, pedido.nameRest, pedido.idBs, pedido.uidBs, pedido.cliente, pedido.autoacctype, pedido)"
                name="checkmark-circle" class="action-large transfer-ok-icon"></ion-icon>
    </div>

    </div>
  </div>

  <!-- Botones de estado grandes (mantengo los icons y handlers que ya tenías) -->
  <div class="footer-actions">

  </div>
</ion-footer>

